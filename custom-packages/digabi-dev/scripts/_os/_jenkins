#
# Common parts for running Jenkins builds
#

if [ -z "${REPOSITORY_HOST}" ]
then
    REPOSITORY_HOST="renki.local"
fi
if [ -z "${PROXY_HOST}" ]
then
    PROXY_HOST="ci.local"
fi

cleanup() {
    make -f Makefile.build purge
}

mdns_resolve() {
    # Linux
    if which avahi-resolve > /dev/null 2>&1 ; then
        avahi-resolve -4 -n "$1" | cut -f2
        return
    fi

    # Mac OS X
    if which dscacheutil > /dev/null 2>&1 ; then
        dscacheutil -q host -a name "$1" | awk '/ip_addr/ {print $2; exit}'
        return
    fi

    echo "Unable to resolve MDNS" 1>&2
    exit 42
}

dns_resolve() {
    host "$1" | awk '/has address/ {print $4; exit}'
}

rm -rf dist
mkdir -p dist


REPOSITORY_IP="$(dns_resolve ${REPOSITORY_HOST})"
PROXY_IP="$(dns_resolve ${PROXY_HOST})"

PROXY="http://${PROXY_IP}:3128/"

if [ -z "${DEBIAN_MIRROR}" ]
then
    DEBIAN_MIRROR="http://${REPOSITORY_IP}/debian"
fi

if [ -z "${ARCH}" ]
then
    ARCH="i386"
fi

export DEBIAN_MIRROR="${DEBIAN_MIRROR}"
export ARCH="${ARCH}"
export http_proxy="${PROXY}"
